<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: backend/server/helpers/UserHelper.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: backend/server/helpers/UserHelper.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file A helper for common user actions
 */

 const admin = require('firebase-admin');
 const winston = require('winston');

 /**
  * Looks up a firebase user by their email
  * @param {string} email the email of the user to lookup
  * @returns {Promise} A promise that contains a Firebase DataSnapshot with the relevant user
  */
 const getFirebaseUserByEmail = (email) => {
  winston.info(
    'UserHelper.getFirebaseUserByEmail - looking up user with email %s',
    email
  );

  const usersRef = admin.database().ref('/users');
  try {
    // TODO: figure out how to notify if email wasn't found
    return usersRef.orderByChild('email').equalTo(email).limitToFirst(1)
      .once('child_added').catch((error) => {
        winston.error(
          'UserHelper.getFirebaseUserByEmail - Error looking up user by email %s. Error message: %s',
          email,
          error.message
        );
      });
  }
  catch (error) {
    winston.error(
      'UserHelper.getFirebaseUserByEmail - Error looking up user by email %s. Error message: %s',
      email,
      error.message
    );
  }
};

/**
 * Adds a user specified by email to the canvas designated by canvasId
 * @param {string} email the email of the user to add the the canvas
 * @param {string} canvasId the canvas id of the canvas to add the user to
 * @returns {void}
*/
const addUserToCanvasByEmail = (email, canvasId) => {
  winston.info(
    'UserHelper.addUserToCanvasByEmail - adding user %s to canvas %s',
    email,
    canvasId
  );

  getFirebaseUserByEmail(email).then((userSnap) => {
    const canvasRef = admin.database().ref('/canvases/' + canvasId);

    try {
      // add user to the canvas's user list
      canvasRef.child('/users').transaction((oldValue) => {
        winston.info(
          'UserHelper.addUserToCanvasByEmail - writing user %s to canvas %s',
          email,
          canvasId
        );
        if(!oldValue)
          oldValue = {};
        oldValue[userSnap.key] = userSnap.child('email').val();
        return oldValue;
      }).then(() => {
        winston.info(
          'UserHelper.addUserToCanvasByEmail - successfully added user %s to canvas %s',
          email,
          canvasId
        );
      }).catch((error) => {
        winston.error(
          'UserHelper.addUserToCanvasByEmail - error adding user %s to canvas %s: %s',
          email,
          canvasId,
          error.message
        );
      });
    } catch (error) {
      winston.error(
        'UserHelper.addUserToCanvasByEmail - error adding user %s to canvas %s: %s',
        email,
        canvasId,
        error.message
      );
    }

    try {
      // add canvas to the user's canvas list
      canvasRef.child('name').once('value').then((canvasNameSnap) => {
        admin.database().ref('/users/' + userSnap.key + '/canvases')
          .transaction((oldValue) => {
            winston.info(
              'UserHelper.addUserToCanvasByEmail - writing canvas %s to user %s',
              canvasId,
              email
            );

            if(!oldValue)
              oldValue = {};
            oldValue[canvasId] = canvasNameSnap.val();
            return oldValue;
          }).then(() => {
            winston.info(
              'UserHelper.addUserToCanvasByEmail - successfully added canvas %s to user %s',
              canvasId,
              email
            );
          }).catch((error) => {
            winston.error(
              'UserHelper.addUserToCanvasByEmail - error adding canvas %s to user %s: %s',
              canvasId,
              email,
              error.message
            );
          });
      });
    } catch (error) {
      winston.error(
        'UserHelper.addUserToCanvasByEmail - error adding canvas %s to user %s: %s',
        canvasId,
        email,
        error.message
      );
    }
  });
 };

/**
 * Adds a user specified by uid to the canvas designated by canvasId
 * @param {string} uid the user id of the user to add the the canvas
 * @param {string} canvasId the canvas id of the canvas to add the user to
 * @returns {void}
*/
const addUserToCanvasByUid = (uid, canvasId) => {
  winston.info(
    'UserHelper.addUserToCanvasByUid - adding user %s to canvas %s',
    uid,
    canvasId
  );

  const userRef = admin.database().ref('/users/' + uid);
  const canvasRef = admin.database().ref('/canvases/' + canvasId);

  try {
    // adding user to canvas
    userRef.once('value').then((userSnap) => {
      canvasRef.child('users').transaction((oldValue) => {
        winston.info(
          'UserHelper.addUserToCanvasByUid - writing user %s to canvas %s',
          userSnap.key,
          canvasId
        );

        if(!oldValue)
          oldValue = {};

        oldValue[userSnap.key] = userSnap.child('email').val();
        return oldValue;
      }).then(() => {
        winston.info(
          'UserHelper.addUserToCanvasByUid - successfully added user %s to canvas %s',
          uid,
          canvasId
        );
      }).catch((error) => {
        winston.error(
          'UserHelper.addUserToCanvasByUid - error adding user %s to canvas %s: %s',
          uid,
          canvasId,
          error.message
        );
      });
    });
  } catch (error) {
    winston.error(
      'UserHelper.addUserToCanvasByUid - error adding user %s to canvas %s: %s',
      uid,
      canvasId,
      error.message
    );
  }

  try {
    // add canvas to the user's canvas list
    canvasRef.child('name').once('value').then((canvasNameSnap) => {
      userRef.child('canvases').transaction((oldValue) => {
        winston.info(
          'UserHelper.addUserToCanvasByUid - writing canvas %s to user %s',
          canvasId,
          uid
        );

        if(!oldValue)
          oldValue = {};

        oldValue[canvasId] = canvasNameSnap.val();
        return oldValue;
      }).then(() => {
        winston.info(
          'UserHelper.addUserToCanvasByUid - successfully added canvas %s to user %s',
          canvasId,
          uid
        );
      }).catch((error) => {
        winston.error(
          'UserHelper.addUserToCanvasByUid - error adding canvas %s to user %s: %s',
          canvasId,
          uid,
          error.message
        );
      });
    });
  } catch (error) {
    winston.error(
      'UserHelper.addUserToCanvasByUid - error adding canvas %s to user %s: %s',
      canvasId,
      uid,
      error.message
    );
  }
};

module.exports = {
  getFirebaseUserByEmail,
  addUserToCanvasByEmail,
  addUserToCanvasByUid
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CanvasElement.html">CanvasElement</a></li><li><a href="CanvasView.html">CanvasView</a></li><li><a href="ExportModal.html">ExportModal</a></li><li><a href="MainLayout.html">MainLayout</a></li><li><a href="module.exports.html">exports</a></li><li><a href="RotationSlider.html">RotationSlider</a></li><li><a href="ShareCanvasModal.html">ShareCanvasModal</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addUserToCanvasByEmail">addUserToCanvasByEmail</a></li><li><a href="global.html#addUserToCanvasByUid">addUserToCanvasByUid</a></li><li><a href="global.html#BOARDS_PATH">BOARDS_PATH</a></li><li><a href="global.html#Canvas">Canvas</a></li><li><a href="global.html#CanvasList">CanvasList</a></li><li><a href="global.html#CreateCanvas">CreateCanvas</a></li><li><a href="global.html#CreateNewCanvas">CreateNewCanvas</a></li><li><a href="global.html#currentCanvasReducer">currentCanvasReducer</a></li><li><a href="global.html#formRequestBody">formRequestBody</a></li><li><a href="global.html#generateScript">generateScript</a></li><li><a href="global.html#getFirebaseUserByEmail">getFirebaseUserByEmail</a></li><li><a href="global.html#handleRequest">handleRequest</a></li><li><a href="global.html#Home">Home</a></li><li><a href="global.html#initElements">initElements</a></li><li><a href="global.html#initFirebase">initFirebase</a></li><li><a href="global.html#insertIntoState">insertIntoState</a></li><li><a href="global.html#Landing">Landing</a></li><li><a href="global.html#manageLogin">manageLogin</a></li><li><a href="global.html#NavBar">NavBar</a></li><li><a href="global.html#OptionsBar">OptionsBar</a></li><li><a href="global.html#Preview3D">Preview3D</a></li><li><a href="global.html#promptForLogin">promptForLogin</a></li><li><a href="global.html#reducers">reducers</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#Routes">Routes</a></li><li><a href="global.html#sendRequest">sendRequest</a></li><li><a href="global.html#setElementLocation">setElementLocation</a></li><li><a href="global.html#setElementRotation">setElementRotation</a></li><li><a href="global.html#setElementSize">setElementSize</a></li><li><a href="global.html#signOut">signOut</a></li><li><a href="global.html#storeConstructor">storeConstructor</a></li><li><a href="global.html#targetElement">targetElement</a></li><li><a href="global.html#updateAndPersist">updateAndPersist</a></li><li><a href="global.html#updateElement">updateElement</a></li><li><a href="global.html#updateElementReducer">updateElementReducer</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.0-dev</a> on Fri Mar 03 2017 18:57:53 GMT-0700 (Mountain Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
